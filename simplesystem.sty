
% 2025 Simple·System

\NeedsTeXFormat {LaTeX2e}
\ProvidesPackage {simplesystem} [Preview 20]


% --------------------------------------------------
% | 外部宏包 | External Packages |
% --------------------------------------------------

\RequirePackage {xcolor, xparse, xstring}
\RequirePackage {tikz, tocloft, amsmath}
\RequirePackage [hidelinks] {hyperref}


% --------------------------------------------------
% | Simple·System 图标 | Simple·System Logo |
% --------------------------------------------------

\newcommand \plotsetting {
	\draw[
		black,
		ultra thick,
		domain = 0:360,
		smooth,
		samples = 100
	]
}
\newcommand \SimpleSystem {
    \begin{tikzpicture} [scale=0.3]
		\plotsetting
		plot (\x: {3.14159 - 0.36788 * cos (5 * \x)});
		\plotsetting
		plot (\x: {3.14159 + 0.36788 * cos (5 * \x)});
	\end{tikzpicture}
}


% --------------------------------------------------
% | LaTeX3 编程层 | LaTeX3 Programming Layer |
% --------------------------------------------------

\ExplSyntaxOn


% --------------------------------------------------
% | 变量声明 | Variables' Declarations |
% --------------------------------------------------

\newcounter {serial}

\tl_new:N \l_parttitlename_tl
\tl_new:N \l_chaptername_tl
\tl_new:N \l_subchaptername_tl
\tl_new:N \l_sectionlabel_tl
\tl_new:N \l_sectionname_tl
\tl_new:N \l_blockname_tl
\tl_new:N \l_blockcontent_tl
\tl_new:N \l_targetchaptername_tl
\tl_new:N \l_targetsubchaptername_tl
\tl_new:N \l_targetsectionlabel_tl
\tl_new:N \l_targetsectionname_tl
\tl_new:N \l_targetblockname_tl
\tl_new:N \l_linktext_tl
\tl_new:N \l_parameterA_tl
\tl_new:N \l_parameterB_tl
\iow_new:N \g_scrfile_iow
\iow_new:N \g_sstfile_iow
\prop_new:N \g_sectionname_prop
\prop_new:N \g_blockname_prop
\clist_new:N \l_register_clist

\tl_new:N \g_CatalogTitle_format_tl
\tl_new:N \g_CatalogPartTitle_format_tl
\tl_new:N \g_CatalogSection_format_tl
\tl_new:N \g_CatalogIndex_format_tl
\tl_new:N \g_IndexTitle_format_tl
\tl_new:N \g_IndexSubchapter_format_tl
\tl_new:N \g_IndexSection_format_tl
\tl_new:N \g_SectionHeading_format_tl
\tl_new:N \g_BlockLink_format_tl
\tl_new:N \g_SectionLink_format_tl
\tl_new:N \g_ChapterLink_format_tl


% --------------------------------------------------
% | 错误处理 | Error Handling |
% --------------------------------------------------

\msg_new:nnnn {SimpleSystemTeX} {SectionPositioningError} {
    Section~'#1'~positioning~failed.
} {
    Please~ensure~that~the~'\ImportSection'~command~has~been~used~correctly~to~import~section~'#1'.
}

\msg_new:nnnn {SimpleSystemTeX} {BlockPositioningError} {
    Block~'#1'~positioning~failed.
} {
    Please~ensure~that~the~block~'#1'~has~been~created.
}


% --------------------------------------------------
% | 试验语法 | Experimental Syntax |
% --------------------------------------------------

% 自动列表 | Automatic List

\cs_new:Npn \translate_format:N #1 {
    \setcounter {serial} 0
    \tl_replace_all:Nnn #1 { ~+~ } {
        \stepcounter{serial}
        \par\noindent\textbf{\theserial.}~
    }
    \tl_replace_all:Nnn #1 { ~-~ } {
        \par\noindent\textbf{\textbullet}\,
    }
}

% 对齐优化 | Alignment Optimization

\cs_new:Npn \align_transform:N #1 {
    %\regex_replace_all:nnN { \& } { \c{;}\c{!}\c{!}\c{!}\&\c{;}\c{!}\c{!}\c{!} } #1
}


% --------------------------------------------------
% | 导言区 (分析层) | Preamble (Parser) |
% --------------------------------------------------

\AtBeginDocument{
    \iow_open:Nn \g_scrfile_iow { \c_sys_jobname_str.scr }
    \iow_open:Nn \g_sstfile_iow { \c_sys_jobname_str.sst }
}

\NewDocumentCommand \NewBlockType {s m} {
    \tl_new:c {g_#2_format_tl}
    \exp_args:Nc \NewDocumentCommand {#2} {m d() d<> +m} {
        \group_begin:
        \tl_set:Nn \l_parameterB_tl {##3}
        \IfNoValueTF {##2} {
            \tl_set:Nn \l_blockname_tl {##1}
            \prop_gput:Nnn \g_blockname_prop {##1} {##1}
        } {
            \tl_set:Nn \l_blockname_tl {##2}
            \prop_gput:Nnn \g_blockname_prop {##1} {##2}
        }
        \IfBooleanF {#1} {
            \phantomsection
            \label{·\l_chaptername_tl·\l_subchaptername_tl|##1}
        }
        \tl_set:Nn \l_blockcontent_tl {##4}
        \translate_format:N \l_blockcontent_tl
        \tl_use:c {g_#2_format_tl}
        \group_end:
    }
}

\NewDocumentCommand \ImportSection {m d[] m d() d<>} {
    \IfNoValueTF {#4} {
        \prop_gput:Nnn \g_sectionname_prop {#3} {#3}
    } {
        \prop_gput:Nnn \g_sectionname_prop {#3} {#4}
    }
    \iow_now:Nn \g_sstfile_iow {\Section {#1} {#2} {#3} {#5}}
    \iow_now:Nn \g_scrfile_iow {\Section {#1} {#2} {#3} {#5}}
}

\NewDocumentCommand \MakeSimpleCatalog {} {
    \iow_now:Nn \g_sstfile_iow {\Catalog}
}

\NewDocumentCommand \MakeSimpleIndex {m d[] d<>} {
    \iow_now:Nn \g_sstfile_iow {\Index {#1} {#2} {#3}}
    \iow_now:Nn \g_scrfile_iow {\Index {#1} {#3}}
}

\NewDocumentCommand \TextCommand {v} {
    \iow_now:Nn \g_sstfile_iow {#1}
}

\NewDocumentCommand \CatalogPart {m} {
    \iow_now:Nn \g_scrfile_iow {\Part {#1}}
}

\NewDocumentCommand \CatalogCommand {v} {
    \iow_now:Nn \g_scrfile_iow {\Command {#1}}
}


% --------------------------------------------------
% | 导言区 (执行层) | Preamble (Executor) |
% --------------------------------------------------

\AtEndDocument{
    \iow_close:N \g_scrfile_iow
    \iow_close:N \g_sstfile_iow
    \file_if_exist:nT {\c_sys_jobname_str.sst}
    {\file_input:n {\c_sys_jobname_str.sst}}
}

\NewDocumentCommand \PrintCatalogTitle {} {
    {\g_CatalogTitle_format_tl}
}

\NewDocumentCommand \PrintCatalogPartTitle {} {
    {\g_CatalogPartTitle_format_tl}
}

\NewDocumentCommand \PrintCatalogSection {m m m m} {
    \group_begin:
    \tl_set:Nn \l_chaptername_tl {#1}
    \tl_set:Nn \l_subchaptername_tl {#2}
    \tl_set:Nn \l_sectionlabel_tl {#3}
    \tl_set:Nn \l_parameterA_tl {#4}
    \prop_get:NnN \g_sectionname_prop {#3} \l_sectionname_tl
    {\g_CatalogSection_format_tl}
    \group_end:
}

\NewDocumentCommand \PrintCatalogIndex {m m} {
    \group_begin:
    \tl_set:Nn \l_chaptername_tl {#1}
    \tl_set:Nn \l_parameterA_tl {#2}
    {\g_CatalogIndex_format_tl}
    \group_end:
}

\NewDocumentCommand \PrintIndexTitle {} {
    \phantomsection
    \label{\l_chaptername_tl·-NoValue-}
    \group_begin:
    {\g_IndexTitle_format_tl}
    \group_end:
}

\NewDocumentCommand \PrintIndexSubchapter {} {
    \phantomsection
    \label{\l_chaptername_tl·\l_subchaptername_tl}
    \group_begin:
    {\g_IndexSubchapter_format_tl}
    \group_end:
}

\NewDocumentCommand \PrintIndexSection {m} {
    \group_begin:
    \tl_set:Nn \l_sectionlabel_tl {#1}
    \prop_get:NnN \g_sectionname_prop {#1} \l_sectionname_tl
    {\g_IndexSection_format_tl}
    \group_end:
}

\NewDocumentCommand \PrintSectionHeading {} {
    \phantomsection
    \label{\l_chaptername_tl·\l_subchaptername_tl|\l_sectionlabel_tl}
    \group_begin:
    \prop_get:NoN \g_sectionname_prop \l_sectionlabel_tl \l_sectionname_tl
    {\g_SectionHeading_format_tl}
    \group_end:
}

% 超链接 | Hyperlink

\NewDocumentCommand \link {m d[] m d() d<>} {
    \group_begin:
    \tl_set:Nn \l_targetchaptername_tl {#1}
    \tl_set:Nn \l_targetsubchaptername_tl {#2}
    \tl_set:Nn \l_linktext_tl {#4}
    \tl_set:Nn \l_parameterB_tl {#5}
    \prop_if_in:NeTF \g_blockname_prop {#3} {
        \prop_get:NeN \g_blockname_prop {#3} \l_targetblockname_tl
    } {
        \msg_warning:nne {SimpleSystemTeX} {BlockPositioningError} {#3}
    }
    \hyperref [·#1·#2|#3] {{\g_BlockLink_format_tl}}
    \group_end:
}

\NewDocumentCommand \seclink {m d[] m d() d<>} {
    \group_begin:
    \tl_set:Nn \l_targetchaptername_tl {#1}
    \tl_set:Nn \l_targetsubchaptername_tl {#2}
    \tl_set:Nn \l_linktext_tl {#4}
    \tl_set:Nn \l_parameterB_tl {#5}
    \prop_if_in:NeTF \g_sectionname_prop {#3} {
        \prop_get:NeN \g_sectionname_prop {#3} \l_targetsectionname_tl
    } {
        \msg_warning:nne {SimpleSystemTeX} {SectionPositioningError} {#3}
    }
    \hyperref [#1·#2|#3] {{\g_SectionLink_format_tl}}
    \group_end:
}

\NewDocumentCommand \cptlink {m d[] d() d<>} {
    \group_begin:
    \tl_set:Nn \l_targetchaptername_tl {#1}
    \tl_set:Nn \l_targetsubchaptername_tl {#2}
    \tl_set:Nn \l_linktext_tl {#3}
    \tl_set:Nn \l_parameterB_tl {#4}
    \hyperref [#1·#2] {{\g_ChapterLink_format_tl}}
    \group_end:
}

\cs_set:Npn \Section #1 #2 #3 #4 {

    \group_begin:

    \tl_set:Nn \l_chaptername_tl {#1}
    \tl_set:Nn \l_subchaptername_tl {#2}
    \tl_set:Nn \l_sectionlabel_tl {#3}
    \tl_set:Nn \l_parameterA_tl {#4}
    \prop_get:NnN \g_sectionname_prop {#3} \l_sectionname_tl

    \PrintSectionHeading

    \str_if_eq:nnTF {#2} {-NoValue-} {
        \iow_term:n {[SimpleSystemTeX]~Importing~section~"#1|#3"~...}
        \file_if_exist:nTF {./sec/#1/#3.tex} {
            \file_input:n {./sec/#1/#3.tex}
            \iow_term:n {[SimpleSystemTeX]~Section~"#1|#3"~imported.}
        } {
            \iow_term:n {[SimpleSystemTeX]~Section~"#1|#3"~importing~failed.~(Not~found)}
        }
    } {
        \iow_term:n {[SimpleSystemTeX]~Importing~section~"#1·#2|#3"~...}
        \file_if_exist:nTF {./sec/#1/#2/#3.tex} {
            \file_input:n {./sec/#1/#2/#3.tex}
            \iow_term:n {[SimpleSystemTeX]~Section~"#1·#2|#3"~imported.}
        } {
            \iow_term:n {[SimpleSystemTeX]~Section~"#1·#2|#3"~importing~failed.~(Not~found)}
        }
    }

    \group_end:

}

\cs_set:Npn \Catalog {

    \group_begin:

    \cs_set:Npn \Part ##1 {
        \tl_set:Nn \l_parttitlename_tl {##1}
        \PrintCatalogPartTitle
    }
    \cs_set:Npn \Command ##1 {##1}
    \cs_set_eq:NN \Section \PrintCatalogSection
    \cs_set_eq:NN \Index \PrintCatalogIndex

    \iow_term:n {[SimpleSystemTeX]~Making~catalog ...}
    \PrintCatalogTitle
    \file_if_exist:nT {\c_sys_jobname_str.scr}
    {\file_input:n {\c_sys_jobname_str.scr}}
    \iow_term:n {[SimpleSystemTeX]~Catalog~made.}

    \group_end:

}

\cs_set:Npn \Index #1 #2 #3 {

    \group_begin:

    \tl_set:Nn \l_chaptername_tl {#1}
    \tl_set:Nn \l_parameterA_tl {#3}

    \iow_term:n {[SimpleSystemTeX]~Making~index~"#1"~...}

    \PrintIndexTitle

    \clist_set:Nn \l_register_clist {}
    \cs_set:Npn \Section ##1 ##2 ##3 ##4 {
        \str_if_eq:nnT {##1} {#1} {
            \seq_if_exist:cF {chapter_queue_#1_##2} {
                \seq_new:c {chapter_queue_#1_##2}
                \clist_put_right:Nn \l_register_clist {##2}
            }
            \seq_gput_right:cn {chapter_queue_#1_##2} {##3}
        }
    }
    \cs_set_eq:NN \Part \use_none:n
    \cs_set_eq:NN \Index \use_none:nn
    \cs_set_eq:NN \Command \use_none:n
    \file_if_exist:nT {\c_sys_jobname_str.scr}
    {\file_input:n {\c_sys_jobname_str.scr}}

    \iow_term:x {[SimpleSystemTeX]~Search~for~chapter~"#1"~finished,~which~containing~subchapters:~"\clist_use:Nn \l_register_clist {",~"}"}

    \str_if_eq:eeTF {\str_head:n {#2}} {,} {
        \clist_set:Nn \l_target_clist {-NoValue-#2}
    } {
        \clist_set:Nn \l_target_clist {#2}
    }
    \str_if_eq:nnTF {#2} {-NoValue-} {
        \clist_map_inline:Nn \l_register_clist {
            \tl_set:Nn \l_subchaptername_tl {##1}
            \PrintIndexSubchapter
            \seq_map_inline:cn {chapter_queue_#1_##1} {
                \PrintIndexSection {####1}
            }
            \iow_term:n {[SimpleSystemTeX]~Index~"#1·##1"~printed.}
            \seq_gclear:c {chapter_queue_#1_##1}
        }
    } {
        \clist_map_inline:Nn \l_target_clist {
            \seq_if_exist:cTF {chapter_queue_#1_##1} {
            \tl_set:Nn \l_subchaptername_tl {##1}
                \PrintIndexSubchapter
                \seq_map_inline:cn {chapter_queue_#1_##1} {
                    \PrintIndexSection {####1}
                }
                \iow_term:n {[SimpleSystemTeX]~Index~"#1·##1"~printed.}
                \seq_gclear:c {chapter_queue_#1_##1}
            } {
                \iow_term:n {[SimpleSystemTeX]~Index~"#1·##1"~printing~failed.~(Not~found)}
            }
        }
    }

    \iow_term:n {
        [SimpleSystemTeX]~Index~"#1"~made.
    }

    \group_end:

}


% --------------------------------------------------
% | 预设区块 | Preset Blocks |
% --------------------------------------------------

\NewBlockType {Definition}
\NewBlockType {Theorem}
\NewBlockType {Corollary}
\NewBlockType* {Proof}


% --------------------------------------------------
% | 样式设定 | Format Settings |
% --------------------------------------------------

\NewDocumentCommand \FormatSetting {m +m} {
    \tl_gset:cn {g_#1_format_tl} {#2}
    \exp_args:Nnnc \regex_replace_all:nnN {<([a-zA-Z]+)>} {\c{l_\1_tl}} {g_#1_format_tl}
    \exp_args:Nnnc \regex_replace_all:nnN {\#ifempty} {\c{newifempty}} {g_#1_format_tl}
    \exp_args:Nnnc \regex_replace_all:nnN {\#ifequal} {\c{newifequal}} {g_#1_format_tl}
}

% 条件宏 | Condition Macros

\newcommand \newifempty [3] {
    \str_if_eq:VnTF {#1} {-NoValue-} {#2} {#3}
}
\newcommand \newifequal [4] {
    \str_if_eq:VnTF {#1} {#2} {#3} {#4}
}

% 预设值 | Default Values


% --------------------------------------------------
% | 数学指令 | Mathematical Commands |
% --------------------------------------------------

% 字母符号 | Letter Symbols

\newcommand \rmd {\mathrm{d}}
\newcommand \rme {\mathrm{e}}
\newcommand \rmi {\mathrm{i}}
\newcommand \rmC {\mathrm{C}}
\newcommand \rmH {\mathrm{H}}
\newcommand \rmT {\mathrm{T}}
\newcommand \bfC {\mathbf{C}}
\newcommand \bfF {\mathbf{F}}
\newcommand \bfN {\mathbf{N}}
\newcommand \bfQ {\mathbf{Q}}
\newcommand \bfR {\mathbf{R}}
\newcommand \bfZ {\mathbf{Z}}
\renewcommand \phi \varphi
\renewcommand \epsilon \varepsilon
\renewcommand \emptyset \varnothing

% 分隔符 | Separators

\let\and\relax
\newcommand \and {\,,\,}
\newcommand \by {\,;\,}
\newcommand \AND {\quad\mathrm{and}\quad}
\newcommand \OR {\quad\mathrm{or}\quad}

% 括号 | Brackets

\newcommand \braI [1] {\left(\;\!#1\;\!\right)}
\newcommand \braII [1] {\left[\;#1\;\right]}
\newcommand \braIII [1] {\left\{\;\!#1\;\!\right\}}
\newcommand \braIV [1] {\left|\,#1\,\right|}
\newcommand \braV [1] {\left\langle\,#1\,\right\rangle}
\newcommand \braVI [1] {\left(\;\!#1\;\right]}
\newcommand \braVII [1] {\left[\;#1\;\!\right)}
\newcommand \ceil [1] {\left\lceil\;\!#1\;\!\right\rceil}
\newcommand \floor [1] {\left\lfloor\;\!#1\;\!\right\rfloor}
\newcommand \norm [1] {\left|\left|\;\!#1\;\!\right|\right|}

% 运算符 | Operators

\newcommand \rdots {\reflectbox{$\ddots$}}
\newcommand \poly [2]{#1\;\![\,#2\,]}
\newcommand \fsq {^{2\!}}
\newcommand \fcu {^{3\!}}
\newcommand \fnpow {^{n\!}}
\newcommand \finv {^{-1\!}}
\newcommand \fder {^{\,\prime\!}}
\newcommand \fdder {^{\,\prime\prime\!}}
\newcommand \fddder {^{\,\prime\prime\prime\!}}
\newcommand \fnder [1] {^{\,(#1)\!}}
\newcommand \sfrac [2] {#1\!\mathbin{\slash}\!#2}
\newcommand \bigsfrac [2] {#1\!\mathbin{\big\slash}\!#2}
\newcommand \Bigsfrac [2] {#1\!\mathbin{\Big\slash}\!#2}
\newcommand \biggsfrac [2] {#1\!\mathbin{\bigg\slash}\!#2}
\newcommand \Biggsfrac [2] {#1\!\mathbin{\Bigg\slash}\!#2}
\newcommand \Int [4] {\int\sb{#1}^{\;\!#2}#3\,\rmd #4}
\newcommand \restrict [1] {\,\big|\sb{\,#1}}
\newcommand \subst [2] {\,\Big|\sb{\,#1}^{\,#2}}
\newcommand \bigsubst [2] {\,\bigg|\sb{\,#1}^{\,#2}}
\newcommand \Bigsubst [2] {\,\Bigg|\sb{\,#1}^{\,#2}}

% 函数名称 | Function Names

\let\Re\relax
\let\Im\relax
\let\char\relax
\DeclareMathOperator \sgn {sgn}
\DeclareMathOperator \Re {Re}
\DeclareMathOperator \Im {Im}
\DeclareMathOperator \char {char}
\DeclareMathOperator \gm {gm}
\DeclareMathOperator \am {am}
\DeclareMathOperator \tr {tr}
\DeclareMathOperator \im {im}
\DeclareMathOperator \rank {rank}
\DeclareMathOperator \spn {span}
\DeclareMathOperator \sech {sech}
\DeclareMathOperator \csch {csch}
\DeclareMathOperator \arccot {arccot}
\DeclareMathOperator \arcsec {arcsec}
\DeclareMathOperator \arccsc {arccsc}
\DeclareMathOperator \arsinh {arsinh}
\DeclareMathOperator \arcosh {arcosh}
\DeclareMathOperator \artanh {artanh}
\DeclareMathOperator \arcoth {arcoth}
\DeclareMathOperator \arsech {arsech}
\DeclareMathOperator \arcsch {arcsch}

% 逻辑量词 | Logical Quantifiers

\newcommand \Forall [2] {\forall\ #1\in #2\ :\ \ }
\newcommand \ForallII [4] {\forall\ #1\in #2\ ,\ #3\in #4\ :\ \ }
\newcommand \Exists [2] {\exists\ #1\in #2\ :\ \ }
\newcommand \ExistsII [4] {\exists\ #1\in #2\ ,\ #3\in #4\ :\ \ }

% 基本结构 | Basic Structures

\NewCommandCopy \originfrac \frac
\RenewDocumentCommand \frac {s +m +m} {
    \IfBooleanTF {#1} {
        \originfrac{#2}{#3}
    } {
        \originfrac{\displaystyle #2}{\displaystyle #3}
    }
}

\NewCommandCopy \originsqrt \sqrt
\RenewDocumentCommand \sqrt {s d[] +m} {
    \IfBooleanTF {#1} {
        \IfValueTF {#2} {
            \originsqrt [#2] {#3}
        } {
            \originsqrt {#3}
        }
    } {
        \IfValueTF {#2} {
            \originsqrt [#2] {\displaystyle #3}
        } {
            \originsqrt {\displaystyle #3}
        }
    }
}

% 矩阵 & 分支 | Matrices & Cases

\let\matrix\relax
\newcommand \casesII [5] {\begin{cases}\\[-10mm]\ \ #1&\quad#2\\[#3mm]\ \ #4&\quad#5\end{cases}}
\newcommand \casesIII [8] {\begin{cases}\\[-10mm]\ \ #1&\quad#2\\[#3mm]\ \ #4&\quad#5\\[#6mm]\ \ #7&\quad#8\end{cases}}
\NewDocumentCommand \matrix {m +m} {
    \tl_set:Nn \l_tmpa_tl {#2}
    \align_transform:N \l_tmpa_tl
    \braI{\;\!\!
        \begin{array}{#1}
            \l_tmpa_tl
        \end{array}
    \;\!\!}
}
\NewDocumentCommand \sqmatrix {m +m} {
    \tl_set:Nn \l_tmpa_tl {#2}
    \align_transform:N \l_tmpa_tl
    \braII{\;\!
        \begin{array}{#1}
            \l_tmpa_tl
        \end{array}
    \;\!}
}
\NewDocumentCommand \determinant {m +m} {
    \tl_set:Nn \l_tmpa_tl {#2}
    \align_transform:N \l_tmpa_tl
    \braIV{
        \begin{array}{#1}
            \l_tmpa_tl
        \end{array}
    }
}

% 通用公式环境 | General Formula Environments

\NewDocumentCommand \Equation {s +m} {
    \IfBooleanTF {#1} {
        \[\resizebox{\textwidth}{!}{$
            \displaystyle
            \begin{aligned}
                #2
            \end{aligned}
        $}\]
    } {
        \begin{align*}
            #2
        \end{align*}
    }
}

\ExplSyntaxOff

\endinput
